spec_version: 1
kind: application

inputs:
- PORT: 80
- AZURE_VM_SIZE: Standard_B1s

infrastructure:
  compute:
    spec:
      azure:
        vm_size: $AZURE_VM_SIZE

  # Port 80 will be opened externally to receive web requests
  connectivity:
    external:
      - web:
          port: $PORT

# This is a clean Ubuntu server image that will be
# used to create a new EC2 instance in the defined AWS region
source:
  os_type: linux
  image:
    azure_image:
    - urn: Canonical:UbuntuServer:16.04-LTS:latest
      username: adminuser

configuration:
  # The initialization script is intended to install
  # app prerequisite and initialize the OS
  # This script installs wordpress on a clean Ubuntu OS.
  initialization:
    command: >
      apt-get update
      apt install curl -y
      curl -sL https://deb.nodesource.com/setup_10.x | bash -
      apt install nodejs
      apt-get install nginx -y
      git clone https://github.com/kalsky/glass-website --depth 1 --branch=master /var/www/website
      cd /etc/nginx/sites-available/
      cp default default.backup

      cat << EOF > ./default
      server {
        listen 80 default_server;
        listen [::]:80 default_server;
        root /var/www/promotions-manager;
        server_name _;
        index index.html index.htm;
        location /api {   
          proxy_http_version 1.1;
          proxy_set_header Upgrade \$http_upgrade;
          proxy_set_header Connection 'upgrade';
          proxy_set_header Host \$host;
          proxy_cache_bypass \$http_upgrade;
          proxy_read_timeout 600s;
        }
        location / {
          try_files \$uri /index.html;
        }
      }
      EOF
  # This command restarts the Apache server after the initialization completes
  start:
    command: >
      echo 'Start nginx service'
      service nginx stop
      service nginx start
  # To validate the installation, we wait to see that the ports are available
  healthcheck:
    wait_for_ports: ALL
    timeout: 180